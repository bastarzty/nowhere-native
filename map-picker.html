<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>选择地点 | Nowhere Native</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Noto+Serif:ital,wght@0,400;0,700;1,400&family=Space+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1a1f35;
            --accent-color: #64b5f6;
            --bg-color: #0a0e1a;
            --text-color: #e0e0e0;
        }
        
        body {
            font-family: 'Noto Serif', 'Noto Serif SC', serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .header {
            background-color: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .header h2 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--accent-color);
        }
        
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .controls {
            padding: 1rem;
            background-color: rgba(255, 255, 255, 0.05);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .search-box {
            flex: 1;
            margin-right: 1rem;
        }
        
        input {
            width: 100%;
            padding: 0.5rem;
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 4px;
        }
        
        button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.5rem 1rem;
            cursor: pointer;
        }
        
        button:hover {
            background-color: #5095db;
        }
        
        .selected-location {
            padding: 0.5rem;
            font-size: 0.9rem;
            margin-right: 1rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <h2>选择记忆发生的地点</h2>
    </div>
    
    <div class="map-container">
        <div id="map"></div>
    </div>
    
    <div class="controls">
        <div class="search-box">
            <input type="text" id="search-input" placeholder="搜索地点...">
        </div>
        <div class="selected-location" id="selected-location">未选择地点</div>
        <button id="confirm-btn">确认选择</button>
    </div>

    <script>
        let map;
        let marker;
        let geocoder;
        let selectedLocationName = '';
        let selectedLat = 0;
        let selectedLng = 0;
        
        function initMap() {
            // 初始化地图
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 37.7749, lng: -122.4194 }, // 旧金山
                zoom: 10,
                styles: [
                    { elementType: 'geometry', stylers: [{ color: '#242f3e' }] },
                    { elementType: 'labels.text.stroke', stylers: [{ color: '#242f3e' }] },
                    { elementType: 'labels.text.fill', stylers: [{ color: '#746855' }] },
                    {
                        featureType: 'administrative.locality',
                        elementType: 'labels.text.fill',
                        stylers: [{ color: '#d59563' }]
                    },
                    {
                        featureType: 'poi',
                        elementType: 'labels.text.fill',
                        stylers: [{ color: '#d59563' }]
                    },
                    {
                        featureType: 'poi.park',
                        elementType: 'geometry',
                        stylers: [{ color: '#263c3f' }]
                    },
                    {
                        featureType: 'poi.park',
                        elementType: 'labels.text.fill',
                        stylers: [{ color: '#6b9a76' }]
                    },
                    {
                        featureType: 'road',
                        elementType: 'geometry',
                        stylers: [{ color: '#38414e' }]
                    },
                    {
                        featureType: 'road',
                        elementType: 'geometry.stroke',
                        stylers: [{ color: '#212a37' }]
                    },
                    {
                        featureType: 'road',
                        elementType: 'labels.text.fill',
                        stylers: [{ color: '#9ca5b3' }]
                    },
                    {
                        featureType: 'road.highway',
                        elementType: 'geometry',
                        stylers: [{ color: '#746855' }]
                    },
                    {
                        featureType: 'road.highway',
                        elementType: 'geometry.stroke',
                        stylers: [{ color: '#1f2835' }]
                    },
                    {
                        featureType: 'road.highway',
                        elementType: 'labels.text.fill',
                        stylers: [{ color: '#f3d19c' }]
                    },
                    {
                        featureType: 'transit',
                        elementType: 'geometry',
                        stylers: [{ color: '#2f3948' }]
                    },
                    {
                        featureType: 'transit.station',
                        elementType: 'labels.text.fill',
                        stylers: [{ color: '#d59563' }]
                    },
                    {
                        featureType: 'water',
                        elementType: 'geometry',
                        stylers: [{ color: '#17263c' }]
                    },
                    {
                        featureType: 'water',
                        elementType: 'labels.text.fill',
                        stylers: [{ color: '#515c6d' }]
                    },
                    {
                        featureType: 'water',
                        elementType: 'labels.text.stroke',
                        stylers: [{ color: '#17263c' }]
                    }
                ]
            });
            
            geocoder = new google.maps.Geocoder();
            
            // 点击地图添加标记
            map.addListener('click', function(e) {
                placeMarker(e.latLng);
                getLocationName(e.latLng);
            });
            
            // 搜索框功能
            const searchInput = document.getElementById('search-input');
            const searchBox = new google.maps.places.SearchBox(searchInput);
            
            map.addListener('bounds_changed', function() {
                searchBox.setBounds(map.getBounds());
            });
            
            searchBox.addListener('places_changed', function() {
                const places = searchBox.getPlaces();
                
                if (places.length === 0) {
                    return;
                }
                
                const place = places[0];
                
                if (!place.geometry || !place.geometry.location) {
                    console.log("未找到地点: ", place.name);
                    return;
                }
                
                // 移动地图到搜索位置并添加标记
                map.setCenter(place.geometry.location);
                map.setZoom(15);
                placeMarker(place.geometry.location);
                
                selectedLocationName = place.name;
                selectedLat = place.geometry.location.lat();
                selectedLng = place.geometry.location.lng();
                
                updateSelectedLocation();
            });
            
            // 确认按钮功能
            document.getElementById('confirm-btn').addEventListener('click', function() {
                if (selectedLocationName) {
                    window.opener.setSelectedLocation(selectedLocationName, selectedLat, selectedLng);
                    window.close();
                } else {
                    alert('请先选择一个地点');
                }
            });
            
            // 尝试获取用户当前位置
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    map.setCenter(userLocation);
                    map.setZoom(13);
                });
            }
        }
        
        function placeMarker(location) {
            if (marker) {
                marker.setMap(null);
            }
            
            marker = new google.maps.Marker({
                position: location,
                map: map,
                animation: google.maps.Animation.DROP
            });
            
            selectedLat = location.lat();
            selectedLng = location.lng();
        }
        
        function getLocationName(location) {
            geocoder.geocode({ 'location': location }, function(results, status) {
                if (status === 'OK') {
                    if (results[0]) {
                        selectedLocationName = results[0].formatted_address;
                        updateSelectedLocation();
                    } else {
                        selectedLocationName = '未知地点';
                        updateSelectedLocation();
                    }
                } else {
                    console.log('Geocoder 失败: ' + status);
                    selectedLocationName = '未知地点';
                    updateSelectedLocation();
                }
            });
        }
        
        function updateSelectedLocation() {
            document.getElementById('selected-location').textContent = selectedLocationName;
        }
    </script>
    
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places&callback=initMap" async defer></script>
</body>
</html> 